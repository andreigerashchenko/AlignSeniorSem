name: Package and Publish Windows Executable

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

     - name: Check OpenGL version
        run: |
          echo "Checking OpenGL version..."
          $gl_info = wmic path win32_videocontroller get VideoMemoryType /value
          if ($gl_info -match "OpenGL") {
            $gl_version = glxinfo -B | Select-String -Pattern 'OpenGL version string'
            if ($gl_version -match '\d+\.\d+') {
              $gl_major = [double]::Parse($matches[0])
              if ($gl_major -ge 2.0) {
                echo "OpenGL version is 2.0 or higher"
                exit 0
              }
            }
          }
          echo "OpenGL version is less than 2.0"
          echo "Installing Mesa 3D..."
          Invoke-WebRequest -Uri https://www.mesa3d.org/binary/win64/mesa-dist-x64.exe -OutFile mesa-dist-x64.exe
          Start-Process -FilePath mesa-dist-x64.exe -ArgumentList /S, /D=C:\Mesa3D
          $env:Path += ";C:\Mesa3D\bin"
        shell: powershell

    - name: Install Python 3.10.11
      uses: actions/setup-python@v2
      with:
        python-version: 3.10.11

    - name: Create virtual environment
      run: python -m venv env

    - name: Activate virtual environment
      run: .\env\Scripts\activate

    - name: Install build requirements
      run: pip install -r build_requirements_windows.txt

    - name: Build executable
      run: pyinstaller Align.spec

    - name: Archive executable
      uses: actions/upload-artifact@v2
      with:
        name: align-windows-executable
        path: dist/
